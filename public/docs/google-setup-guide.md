# 📖 Google Apps Script 설정 가이드

## 개요

각 업체는 자신의 Google Sheets와 Google Drive를 사용하여 데이터를 관리합니다. 업체관리자는 다음 단계를 따라 Google Apps Script를 설정해야 합니다.

## 🎯 설정 단계

### 1단계: Google Sheets 템플릿 준비

#### 1.1 새 Google Sheets 생성
1. Google Drive에 접속 (drive.google.com)
2. 새로 만들기 → Google Sheets → 빈 스프레드시트
3. 파일 이름을 "공정한웍스_[업체명]"으로 변경

#### 1.2 필수 시트 생성
다음 시트들을 생성하세요:

**현장목록 시트**
```
| 현장명 | 공사명 | 공종코드 | 공종명 | 공사단계 |
|--------|--------|----------|--------|----------|
| 양주신도시 | 용인 서천 | 1 | 발포 | 전 |
```

**항목명관리 시트**
```
| 대표키 | 유사키 |
|--------|--------|
| 현장명 | 공사명,현장명 |
| 일자 | 작업일,날짜 |
| 위치 | 동호수 |
| 공종코드 | 공종명 |
| 물량 | 수량 |
| 공사단계 | 단계 |
```

**사용자 시트** (선택사항)
```
| 이름 | 역할 |
|------|------|
| 홍길동 | 관리자 |
```

### 2단계: Apps Script 코드 추가

#### 2.1 Apps Script 편집기 열기
1. Google Sheets에서: **확장 프로그램** → **Apps Script**
2. 새 편집기가 열립니다

#### 2.2 코드 복사 및 붙여넣기
1. 기본 코드(`function myFunction()`)를 모두 삭제
2. 아래 템플릿 파일의 코드를 복사하여 붙여넣기:
   - 파일: `/public/templates/google-apps-script.gs`
   - 또는 관리자 대시보드에서 제공되는 코드 복사

#### 2.3 저장
1. 파일 이름: "Code.gs" (기본값 유지)
2. 💾 저장 버튼 클릭 (Ctrl+S)

### 3단계: 웹앱으로 배포

#### 3.1 배포 시작
1. Apps Script 편집기 우측 상단: **배포** → **새 배포**

#### 3.2 배포 유형 선택
1. "유형 선택" 클릭 → **웹 앱** 선택

#### 3.3 배포 설정
다음과 같이 설정하세요:

**설명** (선택사항)
```
공정한웍스 웹앱 v1.0
```

**실행 권한**
- **다음 계정으로 실행**: 나 (본인 이메일)

**액세스 권한** ⚠️ 중요!
- **액세스 권한이 있는 사용자**: **모든 사용자** 선택

#### 3.4 배포 완료
1. **배포** 버튼 클릭
2. 권한 승인 팝업이 나타나면:
   - "액세스 권한 확인" 클릭
   - Google 계정 선택
   - "고급" 클릭 → "안전하지 않은 페이지로 이동" 클릭
   - "허용" 클릭

#### 3.5 웹앱 URL 복사
배포가 완료되면 **웹 앱 URL**이 표시됩니다:
```
https://script.google.com/macros/s/AKfycby.../exec
```
이 URL을 복사하세요! 📋

### 4단계: 관리자 대시보드에 등록

#### 4.1 대시보드 접속
1. 공정한웍스 웹사이트 로그인
2. 관리자 대시보드 → **Google 설정** 탭

#### 4.2 설정 입력
다음 정보를 입력하세요:

**Google Apps Script 웹앱 URL** ⭐ (필수)
```
https://script.google.com/macros/s/AKfycby.../exec
```

**Google Spreadsheet ID** ⭐ (필수)
- Google Sheets URL에서 `/d/` 다음 부분
- 예: `https://docs.google.com/spreadsheets/d/1abc...xyz/edit`
- ID: `1abc...xyz`

**Google Drive 폴더 ID** (선택사항)
- 이미지 저장 폴더 ID
- 스크립트가 자동으로 "공정한웍스" 폴더를 생성하므로 선택사항

#### 4.3 설정 저장 및 테스트
1. **설정 저장** 버튼 클릭
2. **연결 테스트** 버튼 클릭
3. "연결 테스트 성공!" 메시지 확인

## 🔍 문제 해결

### 문제: "액세스 권한이 거부되었습니다" 오류

**해결 방법:**
1. Apps Script 편집기 재배포
2. 배포 설정에서 "액세스 권한이 있는 사용자"를 **"모든 사용자"**로 변경
3. 새 배포 버전 생성
4. 새 웹앱 URL을 다시 복사하여 등록

### 문제: "시트를 찾을 수 없음" 오류

**해결 방법:**
1. Google Sheets에 "현장목록", "항목명관리" 시트가 있는지 확인
2. 시트 이름의 띄어쓰기 확인
3. 대소문자 정확히 일치해야 함

### 문제: 연결 테스트 실패

**확인 사항:**
1. 웹앱 URL이 정확한지 확인 (끝에 `/exec` 포함)
2. Google Sheets가 삭제되지 않았는지 확인
3. Apps Script가 정상 배포되었는지 확인
4. 인터넷 연결 확인

### 문제: 이미지가 저장되지 않음

**확인 사항:**
1. Google Drive 용량 확인
2. "현장명" 항목이 entryData에 포함되어 있는지 확인
3. Apps Script 실행 로그 확인 (Apps Script 편집기 → 실행 → 로그)

## 📊 데이터 구조

### 폴더 구조 (Google Drive)
```
공정한웍스/
├── 2025-11-17/
│   ├── 양주신도시/
│   │   ├── 101동/
│   │   │   ├── 발포/
│   │   │   │   ├── image1.jpg
│   │   │   │   └── image2.jpg
│   │   │   └── 석고/
│   │   └── 102동/
│   └── 옥정더퍼스트/
└── 2025-11-18/
```

### 시트 구조 (Google Sheets)
각 현장별로 자동으로 시트가 생성됩니다:

**양주신도시 시트**
```
| 일자 | 현장명 | 위치 | 공종 | 작성자 | 파일명 |
|------|--------|------|------|--------|--------|
| 2025-11-17 | 양주신도시 | 101동 | 발포 | 홍길동 | image1.jpg |
```

## 🔐 보안 권장사항

1. **Google Sheets 공유 설정**
   - 업체 직원들과만 공유
   - "편집 가능" 권한 부여 (필요시)

2. **Google Drive 폴더 권한**
   - "공정한웍스" 폴더는 자동 생성됨
   - 필요시 특정 사용자와만 공유

3. **Apps Script 배포 관리**
   - 정기적으로 배포 버전 관리
   - 문제 발생 시 이전 버전으로 롤백 가능

## 📞 지원

문제가 계속되면:
1. 시스템 관리자에게 문의
2. Google Apps Script 로그 확인
3. 브라우저 개발자 도구 콘솔 확인

---

**설정 완료!** 이제 직원들이 앱을 통해 사진을 업로드할 수 있습니다. 🎉
